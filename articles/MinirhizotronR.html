<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>MinirhizotronR: Depth Resolved Analysis of Segmented Minirhizotron Scans • MinirhizotronR</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="MinirhizotronR: Depth Resolved Analysis of Segmented Minirhizotron Scans">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">MinirhizotronR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/MinirhizotronR.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/jcunow/MinirhizotronR/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>MinirhizotronR: Depth Resolved Analysis of Segmented Minirhizotron Scans</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jcunow/MinirhizotronR/blob/HEAD/vignettes/MinirhizotronR.Rmd" class="external-link"><code>vignettes/MinirhizotronR.Rmd</code></a></small>
      <div class="d-none name"><code>MinirhizotronR.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="guide-on-how-to-use-this-package">Guide on how to use this package:<a class="anchor" aria-label="anchor" href="#guide-on-how-to-use-this-package"></a>
</h2>
<p>MinirhizotronR picks up the work left behind after root scans have
been segemented and root pixel, background pixel, and others have been
identified. You will find some suggestions on how to get to that point
below. We strongly recommend calibrating your tubes <em>in-situ</em> and
note the insertion angle, tube diameter, and soil start in relation to
where the scan starts for every tube (and perhaps timepoints if movment
is expected). A calibration guide will follow at some point.</p>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># devtools::install_github("jcunow/MinirhizotronR")</span></span>
<span><span class="co"># remotes::install_github("jcunow/MinirhizotronR")</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="image-stitching">Image stitching<a class="anchor" aria-label="anchor" href="#image-stitching"></a>
</h2>
<p>If you have longer Minirhizotron tubes one scan doesn’t do the trick
and you need to scan at several depths. In that case you’ll end up with
a set of images for each tube at each time point. For our purposes, we
might want to stitch them together to remove overlap. This will enable
us to arrive at a quasi-continues depth distribution. Stitch before
segmentation - you can find two solution to this here:</p>
<ol style="list-style-type: decimal">
<li>Affine Keyfeature Stitching of all Scans corresponding to a
particular Tube in Time; see Try AffineStitcher.py in StitchR
repository. Works well for feature rich images with more overlap and
less good for homogeneous images with little overlap. Limiting the key
feature mapping to the overlap region should result in better results
(not implemented yet!) <a href="https://github.com/jcunow/ImageStitching" class="external-link uri">https://github.com/jcunow/ImageStitching</a>
</li>
<li>Use ImageJ’s Addon Stitcher. Needs a text file listing the rough
Image positions (ca. 100px overlap). This has a high successrate but is
time intensive.</li>
</ol>
</div>
<div class="section level2">
<h2 id="ai-image-segmentation">AI Image segmentation<a class="anchor" aria-label="anchor" href="#ai-image-segmentation"></a>
</h2>
<p>Image segmentation is critical for any further processing. There are
several options available: Distinguishing between root and background is
essential. Two potential choices:</p>
<ol style="list-style-type: decimal">
<li>
<p>“RootDetector” applied to stitched Images; This software will
return a segmented and skeletonized Image with information stored in
different channels. RootDetector allows to distinguish tape, roots, and
background using the root identification method.<br>
Peters et al. (2023) As good as but much more efficient and reproducible
than human experts in detecting plant roots in minirhizotron images: The
Convolution Neural Network RootDetector <em>Scientific Reports</em>
<strong>13</strong> 1,</p>
<p>Using root tracking will return root production, root decay, and
no-change roots. Using this unlocks a additional Turnover estimation -
Turnover.DPC() Gillert et al. 2023, Tracking Growth and Decay of Plant
Roots in Minirhizotron Images. <em>IEEE/CVF Winter Conference on
Applications of Computer Vision (WACV)</em>, <a href="https://doi.org/10.1109/WACV56688.2023.00369" class="external-link uri">https://doi.org/10.1109/WACV56688.2023.00369</a></p>
<p>Software at <a href="https://github.com/ExPlEcoGreifswald/RootDetector" class="external-link uri">https://github.com/ExPlEcoGreifswald/RootDetector</a></p>
</li>
<li>
<p>“RootPainter” applied to stitched Images; This software returns a
segmented Image.<br>
Smith et al. 2022, RootPainter: deep learning segmentation of biological
images with corrective annotation, <em>New Phytologist</em>
<strong>236</strong> 2, <a href="https://doi.org/10.1111/nph.18387" class="external-link uri">https://doi.org/10.1111/nph.18387</a></p>
<p>Software at <a href="https://github.com/Abe404/root_painter" class="external-link uri">https://github.com/Abe404/root_painter</a></p>
</li>
</ol>
<p>Tipp: split your stitched images if the root detection algorithm has
trouble with the amount of roots of roots. You can rejoin the segmented
images afterwards. But first, look if the settings can be changed to
crank up the maximum root limit.</p>
<p>This is how a root stitched root scan may look like:
<img src="MinirhizotronR_files/figure-html/Input%20Example%20Showcase1-1.png" width="864">
After segmentation, we get pixel group information in different layers
looking somthing like this:
<img src="MinirhizotronR_files/figure-html/Input%20Example%20Showcase2-1.png" width="864"></p>
<p>For many purposes, we will need a skeleton version of the
segmentation:
<img src="MinirhizotronR_files/figure-html/Input%20Example%20Showcase3-1.png" width="864"></p>
</div>
<div class="section level2">
<h2 id="lets-look-at-example-input">Let’s look at example input<a class="anchor" aria-label="anchor" href="#lets-look-at-example-input"></a>
</h2>
<p>First, we need to load the images. The example images were taken in a
sedge fen in north eastern Finland at Oulanka National Park.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jcunow/MinirhizotronR" class="external-link">MinirhizotronR</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># read color image, segmented, and skeletonized</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">rgb_Oulanka2023_Session03_T067</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">seg_Oulanka2023_Session03_T067</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">skl_Oulanka2023_Session01_T067</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">skl_Oulanka2023_Session03_T067</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">TurnoverDPC_data</span><span class="op">)</span></span>
<span></span>
<span><span class="va">seg_Oulanka2023_Session03_T067</span> <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">seg_Oulanka2023_Session03_T067</span><span class="op">)</span></span>
<span><span class="va">rgb_Oulanka2023_Session03_T067</span> <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">rgb_Oulanka2023_Session03_T067</span><span class="op">)</span></span>
<span><span class="va">skl_Oulanka2023_Session01_T067</span> <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">skl_Oulanka2023_Session01_T067</span><span class="op">)</span></span>
<span><span class="va">skl_Oulanka2023_Session03_T067</span> <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">skl_Oulanka2023_Session03_T067</span><span class="op">)</span></span>
<span><span class="va">TurnoverDPC_data</span> <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">TurnoverDPC_data</span><span class="op">)</span></span>
<span><span class="co">#skl_Oulanka2023_Session03_T067 = (skeletonize(seg_Oulanka2023_Session03_T067[[2]], itr= 3))</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="calibration">Calibration<a class="anchor" aria-label="anchor" href="#calibration"></a>
</h2>
<p>It’s important to know how our scans relate to soil depth and where
the tube upside face is located in the image. We assume that we don’t
have <em>in-situ</em> calibration available. Instead, we are going to
give our best guess on soil surface position and the rotation center
position by using tape cover position as proxy.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  </span>
<span><span class="co">### If you have measured the the distance from the soil to the edge of the tube - great, your job is done! </span></span>
<span><span class="co">## Just do this:</span></span>
<span><span class="va">height</span> <span class="op">=</span> <span class="fl">12</span> <span class="co"># cm</span></span>
<span><span class="va">tilt</span> <span class="op">=</span> <span class="fl">45</span> <span class="co"># insertion angle</span></span>
<span><span class="va">dpi</span> <span class="op">=</span> <span class="fl">150</span> <span class="co"># imiage resolution</span></span>
<span></span>
<span><span class="co"># law of sines</span></span>
<span><span class="va">radiant</span> <span class="op">=</span> <span class="va">pi</span><span class="op">/</span><span class="fl">180</span></span>
<span><span class="va">s0.true</span> <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">sin</a></span><span class="op">(</span><span class="op">(</span><span class="fl">90</span><span class="op">)</span> <span class="op">*</span> <span class="va">radiant</span><span class="op">)</span><span class="op">*</span><span class="va">height</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">sin</a></span><span class="op">(</span><span class="va">tilt</span> <span class="op">*</span> <span class="va">radiant</span><span class="op">)</span></span>
<span><span class="va">s0</span> <span class="op">=</span> <span class="va">s0.true</span> <span class="op">*</span> <span class="va">dpi</span> <span class="op">/</span> <span class="fl">2.54</span></span>
<span><span class="va">s0</span> <span class="op">=</span> <span class="va">s0</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/math-generics.html" class="external-link">round</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">### If you don't have any calibration data available - too bad!</span></span>
<span><span class="co">## Try this instead:</span></span>
<span><span class="co"># Based on Tape Cover, soil start is estimated</span></span>
<span><span class="va">s0</span> <span class="op">=</span> <span class="fu">MinirhizotronR</span><span class="fu">::</span><span class="fu"><a href="../reference/SoilSurfE.html">SoilSurfE</a></span><span class="op">(</span><span class="va">rgb_Oulanka2023_Session03_T067</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Soil Surface Beginning in columns: "</span>,<span class="va">s0</span><span class="op">$</span><span class="va">soil0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Soil Surface Beginning in columns: 379"</span></span>
<span><span class="co"># While we're at it, lets estimate the rotion center (Here, we assume that the tape extrusion on the upside of the Tube is perfectly centered - go and calibrate !!!)</span></span>
<span><span class="va">r0</span> <span class="op">=</span> <span class="fu">MinirhizotronR</span><span class="fu">::</span><span class="fu"><a href="../reference/RotationE.html">RotationE</a></span><span class="op">(</span><span class="va">rgb_Oulanka2023_Session03_T067</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Rotation Center in rows: "</span>,<span class="va">r0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Rotation Center in rows: 436.5"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="depth-map">Depth Map<a class="anchor" aria-label="anchor" href="#depth-map"></a>
</h2>
<p>We are ready now to create a depth map. The here goal is to supply
every pixel of the root scans with a depth information. We choose to
include the tube thickness and thereby create a phase shifted cosine
depth map - or ignore it (as traditionally done). Ignoring it will
create a map in which the tube upside is located the same depth as tube
downside (= vertical insertion angle).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">## We want to exclude pixels with tape as part of the soil. Create a mask:</span></span>
<span><span class="co"># The format of 'RootDetector' uses the red channel to show mask and root px, while blue and green only show root px</span></span>
<span><span class="va">mask</span> <span class="op">=</span> <span class="op">(</span><span class="va">seg_Oulanka2023_Session03_T067</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">-</span> <span class="va">seg_Oulanka2023_Session03_T067</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">)</span> <span class="op">/</span> <span class="fl">255</span></span>
<span><span class="va">mask</span> <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/transpose.html" class="external-link">t</a></span><span class="op">(</span><span class="va">mask</span><span class="op">)</span></span>
<span><span class="co">## Create the Map </span></span>
<span><span class="va">center.offset</span> <span class="op">=</span> <span class="va">r0</span>  <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">seg_Oulanka2023_Session03_T067</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">DepthMap</span> <span class="op">=</span> <span class="fu"><a href="../reference/create.depthmap.html">create.depthmap</a></span><span class="op">(</span>im <span class="op">=</span> <span class="va">seg_Oulanka2023_Session03_T067</span>, </span>
<span>                           sinoid <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                           mask <span class="op">=</span> <span class="va">mask</span>,start.soil <span class="op">=</span> <span class="va">s0</span><span class="op">$</span><span class="va">soil0</span>,</span>
<span>                           center.offset <span class="op">=</span> <span class="va">center.offset</span> <span class="op">)</span></span>
<span></span>
<span><span class="co"># Now lets bin the depth to be able to calculate some stats. Analysis on continuous depth will feature in a future release.</span></span>
<span><span class="co"># we use 5cm intervals here but any bandwidth can be used.</span></span>
<span><span class="va">bm</span> <span class="op">=</span> <span class="fu">MinirhizotronR</span><span class="fu">::</span><span class="fu"><a href="../reference/binning.html">binning</a></span><span class="op">(</span><span class="va">DepthMap</span>, nn <span class="op">=</span> <span class="fl">2</span>, <span class="st">"rounding"</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="va">bm</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">bm</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,<span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">bm</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co"># Binned Depthmap Plot</span></span>
<span><span class="va">tbm</span> <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/transpose.html" class="external-link">t</a></span><span class="op">(</span><span class="va">bm</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">tbm</span><span class="op">)</span></span></code></pre></div>
<p><img src="MinirhizotronR_files/figure-html/Create%20a%20depthmap-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="extract-root-scape-features">Extract Root Scape Features<a class="anchor" aria-label="anchor" href="#extract-root-scape-features"></a>
</h2>
<p>With Depth Information ready, we can now analyze the data. Here, we
are interested in 3 key features: Root Coverage, RootScapes Features,
and Peat Characteristics. Let’s get to it:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># A good starting point is selecting the desired depth. Typically, you want to go through all depth to construct a depth distribution. For brevity, we show it for one depth here.</span></span>
<span></span>
<span><span class="co">## We only need one binarized layer</span></span>
<span><span class="co"># one layer gray would usually be a good option, however, there is distinct information stored in the various layers when using 'RootDetector'</span></span>
<span><span class="va">gray.roots</span> <span class="op">=</span> <span class="fu"><a href="../reference/rgb2gray.html">rgb2gray</a></span><span class="op">(</span><span class="va">seg_Oulanka2023_Session03_T067</span><span class="op">)</span></span>
<span><span class="co"># In this format, we can simply do this:</span></span>
<span><span class="va">gray.roots</span> <span class="op">=</span> <span class="va">seg_Oulanka2023_Session03_T067</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> </span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="va">gray.roots</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">gray.roots</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,<span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">gray.roots</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># extracts a depth band from the root image based on the depth map </span></span>
<span><span class="va">rootzone</span> <span class="op">=</span> <span class="fu"><a href="../reference/zone.fun.html">zone.fun</a></span><span class="op">(</span>rootpic <span class="op">=</span> <span class="va">gray.roots</span>, binned.map <span class="op">=</span> <span class="va">bm</span>, indexD <span class="op">=</span> <span class="op">-</span><span class="fl">10</span>, nn <span class="op">=</span> <span class="fl">2</span> <span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Depth: -10cm. Not enough informative pixels. In the whole Image, 100% are NAs after cutting this Depth Slice. Expected NA% is: ~93.33"</span></span>
<span><span class="co"># the output message tells us the there are not enough proper values in the root zone. Lets try again</span></span>
<span><span class="va">rootzone</span> <span class="op">=</span> <span class="fu"><a href="../reference/zone.fun.html">zone.fun</a></span><span class="op">(</span>rootpic <span class="op">=</span> <span class="va">gray.roots</span>, binned.map <span class="op">=</span> <span class="va">bm</span>, indexD <span class="op">=</span> <span class="fl">8</span>, nn <span class="op">=</span> <span class="fl">2</span> <span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">rootzone</span><span class="op">)</span></span></code></pre></div>
<p><img src="MinirhizotronR_files/figure-html/Depth%20Stats-1.png" width="403.2"></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Also do it for the skeletonized version</span></span>
<span><span class="va">rootzone.skeleton</span> <span class="op">=</span> <span class="fu"><a href="../reference/zone.fun.html">zone.fun</a></span><span class="op">(</span><span class="va">skl_Oulanka2023_Session03_T067</span>, binned.map <span class="op">=</span> <span class="va">bm</span>, indexD <span class="op">=</span> <span class="fl">20</span>, nn <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="va">rootzone.skeleton</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">rootzone.skeleton</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,<span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">rootzone.skeleton</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Get the landscape metrics of the root scape - keep the output units in mind (assuming... input and deliver hectar output)</span></span>
<span><span class="va">rsm</span> <span class="op">=</span> <span class="fu"><a href="../reference/RootScapeMetrics.html">RootScapeMetrics</a></span><span class="op">(</span><span class="va">rootzone</span>,indexD <span class="op">=</span> <span class="fl">8</span>, metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="st">"lsm_c_ca"</span>,<span class="st">"lsm_l_ent"</span>,<span class="st">"lsm_c_pd"</span>,</span>
<span>                                      <span class="st">"lsm_c_enn_mn"</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">rsm</span><span class="op">)</span> </span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 4</span></span></span>
<span><span class="co">#&gt;   metric    value object depth</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> ca        3.86  root       8</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> enn_mn    2.05  root       8</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> pd     <span style="text-decoration: underline;">4</span>739.    root       8</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> ent       0.468 root       8</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="exctract-common-parameter">Exctract Common Parameter<a class="anchor" aria-label="anchor" href="#exctract-common-parameter"></a>
</h2>
<p>Get real numbers coverage numbers now</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Get number of Root pixel and Root Length, and Root Thickness</span></span>
<span><span class="va">void</span> <span class="op">=</span> <span class="fl">255</span><span class="op">-</span><span class="op">(</span><span class="va">gray.roots</span><span class="op">)</span></span>
<span><span class="co"># check if extent matches</span></span>
<span></span>
<span><span class="co"># rotate if necessary</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">bm</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span> <span class="op">!=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">gray.roots</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span><span class="va">bm</span> <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/transpose.html" class="external-link">t</a></span><span class="op">(</span><span class="va">bm</span><span class="op">)</span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># retrieve the root pixel sum and the pixel without roots for all depths</span></span>
<span><span class="va">void.sum</span> <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/zonal.html" class="external-link">zonal</a></span><span class="op">(</span> <span class="va">void</span>,<span class="va">bm</span>, <span class="st">"sum"</span> <span class="op">)</span></span>
<span><span class="va">root.sum</span> <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/zonal.html" class="external-link">zonal</a></span><span class="op">(</span><span class="va">gray.roots</span>,<span class="va">bm</span>,<span class="st">"sum"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">void.sum</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"zone"</span>,<span class="st">"sum"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">root.sum</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"zone"</span>,<span class="st">"sum"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># if you want to include this function within a depth wise loop use this</span></span>
<span><span class="va">rootpixel</span> <span class="op">=</span> <span class="fu"><a href="../reference/px.sum.html">px.sum</a></span><span class="op">(</span>root.zone <span class="op">=</span> <span class="va">rootzone</span><span class="op">)</span> <span class="co"># uses the segmented - so its total root pixel</span></span>
<span></span>
<span></span>
<span><span class="co"># for root length do something like this</span></span>
<span><span class="va">kimroot</span> <span class="op">=</span> <span class="fu"><a href="../reference/RootLength.html">RootLength</a></span><span class="op">(</span><span class="va">rootzone.skeleton</span><span class="op">)</span></span>
<span><span class="co"># lastly Root thickness</span></span>
<span><span class="va">root.thicc</span> <span class="op">=</span> <span class="fu"><a href="../reference/root.thickness.html">root.thickness</a></span><span class="op">(</span>kimuralength <span class="op">=</span> <span class="va">kimroot</span>, rootpx <span class="op">=</span> <span class="va">rootpixel</span>, dpi <span class="op">=</span> <span class="fl">150</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## report:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"total root pixel in this depth: "</span>,<span class="va">rootpixel</span>,<span class="st">" px"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "total root pixel in this depth: 38622 px"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"total root length in this depth: "</span>,<span class="va">kimroot</span>,<span class="st">" cm"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "total root length in this depth: NaN cm"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"average root thickness in this depth: "</span>,<span class="va">root.thicc</span>,<span class="st">" cm"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "average root thickness in this depth: NaN cm"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="correct-for-margins">Correct for Margins<a class="anchor" aria-label="anchor" href="#correct-for-margins"></a>
</h2>
<p>OBS! not all depth have equal amount of tube surface to display
roots! The end pieces of the tilted tube and partially tape covered tube
have smaller tube surface</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># correct for available space</span></span>
<span><span class="va">av.space</span> <span class="op">=</span> <span class="va">root.sum</span> <span class="op">+</span> <span class="va">void.sum</span></span>
<span><span class="va">av.space</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">=</span>  <span class="va">av.space</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">/</span><span class="fl">2</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">av.space</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="st">"total available rooting space"</span><span class="op">)</span></span></code></pre></div>
<p><img src="MinirhizotronR_files/figure-html/standardize%20to%20available%20space-1.png" width="700"></p>
<pre><code><span><span class="co">#&gt; integer(0)</span></span>
<span></span>
<span><span class="va">rootpx_per_av.space</span> <span class="op">=</span>  <span class="va">root.sum</span></span>
<span><span class="va">rootpx_per_av.space</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">=</span> <span class="va">root.sum</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">/</span> <span class="va">av.space</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span></span>
<span><span class="va">df.rootpx_per_av.space</span> <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">rootpx_per_av.space</span><span class="op">)</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span>data<span class="op">=</span><span class="va">df.rootpx_per_av.space</span>,<span class="fu">aes</span><span class="op">(</span><span class="va">zone</span>,<span class="va">sum</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_smooth</span><span class="op">(</span>span<span class="op">=</span><span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme_classic</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ylab</span><span class="op">(</span><span class="st">"% covered by roots"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">xlab</span><span class="op">(</span><span class="st">"Depth [cm]"</span><span class="op">)</span> <span class="op">+</span><span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Roots per available rooting space"</span><span class="op">)</span></span></code></pre>
<p><img src="MinirhizotronR_files/figure-html/standardize%20to%20available%20space-2.png" width="700"></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#ggsave("C:/Users/jocu0013/Documents/GitHub/MinirhizotronR/figures/rootsperavailablespace.png")  </span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="rootsphere-influence">Rootsphere Influence<a class="anchor" aria-label="anchor" href="#rootsphere-influence"></a>
</h2>
<p>What if we want to consider a sphere of influence around the roots
?</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## set hard limits</span></span>
<span><span class="va">root.seg</span> <span class="op">=</span> <span class="va">gray.roots</span> </span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">root.seg</span><span class="op">)</span><span class="op">[</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/transpose.html" class="external-link">t</a></span><span class="op">(</span><span class="va">mask</span><span class="op">)</span><span class="op">)</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span></span>
<span><span class="co"># create a buffer around pixels (12 px == ca. 1mm), Rhizophere exudates 2mm (source)</span></span>
<span><span class="va">buff.im</span> <span class="op">=</span> <span class="fu"><a href="../reference/Halo.html">Halo</a></span><span class="op">(</span><span class="va">root.seg</span>, width <span class="op">=</span> <span class="fl">2</span>, halo.only <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">buff.im</span>, main<span class="op">=</span> <span class="st">"The sphere of influence (roots + 0.3mm each side)"</span><span class="op">)</span> </span></code></pre></div>
<p><img src="MinirhizotronR_files/figure-html/rhizosphere%20tangent-1.png" width="700"></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="co">## lets do some stats on the sphere of influence</span></span>
<span><span class="va">buffer.sum</span> <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/zonal.html" class="external-link">zonal</a></span><span class="op">(</span> <span class="va">buff.im</span>,<span class="va">bm</span>, <span class="st">"sum"</span>,na.rm<span class="op">=</span><span class="cn">TRUE</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">buffer.sum</span><span class="op">)</span><span class="op">)</span>; <span class="fu"><a href="https://rspatial.github.io/terra/reference/lines.html" class="external-link">points</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">root.sum</span><span class="op">)</span>,col<span class="op">=</span><span class="st">"red"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="st">"The difference between distribution of influence (black) vs distribution of rotos (red)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="MinirhizotronR_files/figure-html/rhizosphere%20tangent-2.png" width="700"></p>
<pre><code><span><span class="co">#&gt; integer(0)</span></span>
<span></span>
<span><span class="co"># Hint: sphere of influence might not be the same across depth with varying physiology and hydraulic conductivity</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="estimate-soil-parameter">Estimate Soil Parameter<a class="anchor" aria-label="anchor" href="#estimate-soil-parameter"></a>
</h2>
<p>Can we characterize the Peat too ?</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># only consider soil pixels - not tape nor roots</span></span>
<span><span class="va">peat.color</span> <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="va">rgb_Oulanka2023_Session03_T067</span>,<span class="va">gray.roots</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">peat.color</span><span class="op">)</span><span class="op">[</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">buff.im</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">=</span> <span class="cn">NA</span> </span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">peat.color</span><span class="op">)</span><span class="op">[</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/transpose.html" class="external-link">t</a></span><span class="op">(</span><span class="va">mask</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">=</span> <span class="cn">NA</span> </span>
<span><span class="co"># plot &amp; color</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plotRGB.html" class="external-link">plotRGB</a></span><span class="op">(</span><span class="va">peat.color</span><span class="op">)</span></span></code></pre></div>
<p><img src="MinirhizotronR_files/figure-html/Characterize%20the%20soil-1.png" width="700"></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tube.color.peat</span> <span class="op">=</span> <span class="fu"><a href="../reference/Tube.coloration.html">Tube.coloration</a></span><span class="op">(</span><span class="va">peat.color</span><span class="op">)</span>;<span class="va">tube.color.peat</span></span>
<span><span class="co">#&gt;      rcc    gcc    bcc        hue saturation luminosity      red    green</span></span>
<span><span class="co">#&gt; 1 0.4537 0.3038 0.2424 0.04923419  0.4441139  0.1709672 43.59664 29.95436</span></span>
<span><span class="co">#&gt;       blue</span></span>
<span><span class="co">#&gt; 1 24.23477</span></span>
<span></span>
<span></span>
<span><span class="co"># now only consider roots</span></span>
<span><span class="va">root.color</span> <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="va">rgb_Oulanka2023_Session03_T067</span>,<span class="va">gray.roots</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">root.color</span><span class="op">)</span><span class="op">[</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">gray.roots</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">=</span> <span class="cn">NA</span> </span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">root.color</span><span class="op">)</span><span class="op">[</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/values.html" class="external-link">values</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/transpose.html" class="external-link">t</a></span><span class="op">(</span><span class="va">mask</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">=</span> <span class="cn">NA</span> </span>
<span><span class="co"># plot &amp; color</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plotRGB.html" class="external-link">plotRGB</a></span><span class="op">(</span><span class="va">root.color</span>, main <span class="op">=</span> <span class="st">"available root pixel"</span><span class="op">)</span> </span></code></pre></div>
<p><img src="MinirhizotronR_files/figure-html/Characterize%20the%20soil-2.png" width="700"></p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tube.color.root</span> <span class="op">=</span> <span class="fu"><a href="../reference/Tube.coloration.html">Tube.coloration</a></span><span class="op">(</span><span class="va">root.color</span><span class="op">)</span>;<span class="va">tube.color.root</span></span>
<span><span class="co">#&gt;      rcc    gcc    bcc        hue saturation luminosity      red    green</span></span>
<span><span class="co">#&gt; 1 0.4126 0.3182 0.2692 0.05777937  0.3207919  0.2450358 62.48412 49.38863</span></span>
<span><span class="co">#&gt;       blue</span></span>
<span><span class="co">#&gt; 1 42.43972</span></span>
<span></span>
<span><span class="co">##  Lets try to get texture information as well</span></span>
<span><span class="va">gray.peat</span> <span class="op">=</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/raster.html" class="external-link">raster</a></span><span class="op">(</span><span class="fu"><a href="../reference/rgb2gray.html">rgb2gray</a></span><span class="op">(</span><span class="va">peat.color</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">void.tx</span> <span class="op">=</span> <span class="fu">glcm</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/glcm/man/glcm.html" class="external-link">glcm</a></span><span class="op">(</span><span class="va">gray.peat</span>,n_grey <span class="op">=</span> <span class="fl">7</span>,window <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">9</span>,<span class="fl">9</span><span class="op">)</span>, </span>
<span>                     statistics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"second_moment"</span>,<span class="st">"homogeneity"</span><span class="op">)</span>,</span>
<span>                     shift<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#void.tx = terra::rast(void.tx)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">void.tx</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">"available texture pixels and their second moment characteristic"</span><span class="op">)</span> </span></code></pre></div>
<p><img src="MinirhizotronR_files/figure-html/Characterize%20the%20soil-3.png" width="700"></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## extent don't match</span></span>
<span><span class="va">bm2</span> <span class="op">=</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/brick.html" class="external-link">brick</a></span><span class="op">(</span><span class="va">bm</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="va">bm</span><span class="op">)</span> <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="va">void.tx</span><span class="op">)</span> </span>
<span><span class="va">tx.mean</span> <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/zonal.html" class="external-link">zonal</a></span><span class="op">(</span><span class="va">void.tx</span>,<span class="va">bm2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">tx.mean</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="st">"second moment - peat texture characterization"</span><span class="op">)</span></span></code></pre></div>
<p><img src="MinirhizotronR_files/figure-html/Characterize%20the%20soil-4.png" width="700"></p>
<pre><code><span><span class="co">#&gt; integer(0)</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="rotational-bias">Rotational Bias<a class="anchor" aria-label="anchor" href="#rotational-bias"></a>
</h2>
<p>As the tube insertion angle increases, the more we expect a
differences between the upside of the tube and the downside. Let’s
estimate the rotational bias</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># remove artefacts</span></span>
<span><span class="va">root.seg.c</span> <span class="op">=</span> <span class="fu"><a href="../reference/RotCensor.html">RotCensor</a></span><span class="op">(</span><span class="va">root.seg</span>,fixed.width <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="co"># lets make the split in 0.5 cm intervals</span></span>
<span><span class="va">dpi</span> <span class="op">=</span> <span class="fl">150</span></span>
<span><span class="va">splits</span> <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/math-generics.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">root.seg</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">/</span><span class="va">dpi</span><span class="op">*</span><span class="fl">2.54</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span></span>
<span><span class="va">rot.df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>rotation <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">splits</span>,rotation.rootpx <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">splits</span><span class="op">)</span> <span class="op">{</span></span>
<span><span class="va">rotation.z</span> <span class="op">=</span> <span class="fu"><a href="../reference/zone.rotation.fun.html">zone.rotation.fun</a></span><span class="op">(</span>rootpic <span class="op">=</span> <span class="va">root.seg</span>, mm<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1500</span>,<span class="fl">4000</span><span class="op">)</span>, kk <span class="op">=</span> <span class="va">splits</span>, k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">k</span><span class="op">-</span><span class="fl">1</span>,<span class="va">k</span><span class="op">)</span><span class="op">)</span>  </span>
<span><span class="va">rot.df</span><span class="op">[</span><span class="va">k</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="../reference/px.sum.html">px.sum</a></span><span class="op">(</span>root.zone <span class="op">=</span> <span class="va">rotation.z</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">rot.df</span><span class="op">$</span><span class="va">sc.rotationpx</span> <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">rot.df</span><span class="op">$</span><span class="va">rotation.rootpx</span><span class="op">)</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span>data<span class="op">=</span> <span class="va">rot.df</span>, <span class="fu">aes</span><span class="op">(</span><span class="va">rotation</span>,<span class="va">sc.rotationpx</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>  </span>
<span>  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">xlab</span><span class="op">(</span><span class="st">"rotation cm"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ylab</span><span class="op">(</span><span class="st">"root px"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_smooth</span><span class="op">(</span>method<span class="op">=</span><span class="st">"lm"</span>, formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">cos</a></span><span class="op">(</span><span class="va">x</span><span class="op">*</span><span class="va">pi</span><span class="op">/</span><span class="fl">16</span><span class="op">)</span>,<span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"cosine fit"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_smooth</span><span class="op">(</span>se<span class="op">=</span><span class="cn">F</span>,<span class="fu">aes</span><span class="op">(</span>color<span class="op">=</span><span class="st">"local smooth"</span><span class="op">)</span>,span <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></code></pre></div>
<p><img src="MinirhizotronR_files/figure-html/Asess%20Rotational%20Bias-1.png" width="700"></p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">## fit a sine curve to the rotation-sliced image</span></span>
<span><span class="fu"><a href="../reference/fitSinCurve.html">fitSinCurve</a></span><span class="op">(</span>tt<span class="op">=</span><span class="va">rot.df</span><span class="op">$</span><span class="va">rotation</span>,yy<span class="op">=</span><span class="va">rot.df</span><span class="op">$</span><span class="va">sc.rotationpx</span><span class="op">)</span></span>
<span><span class="co">#&gt; $amp</span></span>
<span><span class="co">#&gt; [1] 0.8639946</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $phase</span></span>
<span><span class="co">#&gt; [1] 11.30286</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $offset</span></span>
<span><span class="co">#&gt; [1] 0.1276436</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $peak</span></span>
<span><span class="co">#&gt; [1] -5.302862</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $A</span></span>
<span><span class="co">#&gt; [1] -0.8496447</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $B</span></span>
<span><span class="co">#&gt; [1] 0.1568139</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $tss</span></span>
<span><span class="co">#&gt; [1] 39</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $rss</span></span>
<span><span class="co">#&gt; [1] 25.45455</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $R2</span></span>
<span><span class="co">#&gt; [1] 0.3473193</span></span>
<span><span class="co"># test if the variation in the data is 0 or explained by sine function alone </span></span>
<span><span class="va">ryth.test</span> <span class="op">=</span> <span class="fu"><a href="../reference/LR_rhythmicity.html">LR_rhythmicity</a></span><span class="op">(</span>tt<span class="op">=</span><span class="va">rot.df</span><span class="op">$</span><span class="va">rotation</span>,yy<span class="op">=</span><span class="va">rot.df</span><span class="op">$</span><span class="va">sc.rotationpx</span>,period <span class="op">=</span> <span class="va">splits</span><span class="op">-</span><span class="fl">1</span>, method <span class="op">=</span> <span class="st">"LR"</span><span class="op">)</span></span>
<span><span class="va">splits</span> <span class="op">-</span> <span class="va">ryth.test</span><span class="op">$</span><span class="va">phase</span> </span>
<span><span class="co">#&gt; [1] 8.535239</span></span>
<span></span>
<span><span class="co">## if tow tubes are ought to be compared (different insertion angles or tube diameter)</span></span>
<span><span class="va">tt1</span> <span class="op">=</span> <span class="va">rot.df</span><span class="op">$</span><span class="va">rotation</span></span>
<span><span class="va">tt2</span> <span class="op">=</span> <span class="va">rot.df</span><span class="op">$</span><span class="va">rotation</span></span>
<span><span class="va">yy1</span> <span class="op">=</span> <span class="va">rot.df</span><span class="op">$</span><span class="va">sc.rotationpx</span></span>
<span><span class="co"># amplitude 4x times as high</span></span>
<span><span class="va">yy2</span> <span class="op">=</span> <span class="va">rot.df</span><span class="op">$</span><span class="va">sc.rotationpx</span><span class="op">*</span><span class="fl">2</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">rot.df</span><span class="op">$</span><span class="va">rotation</span><span class="op">)</span>,min <span class="op">=</span> <span class="op">-</span><span class="fl">0.1</span>, max <span class="op">=</span> <span class="fl">0.1</span> <span class="op">)</span> <span class="co"># + 20</span></span>
<span><span class="fu"><a href="../reference/WaldTest_diff_amp.html">WaldTest_diff_amp</a></span><span class="op">(</span>tt1<span class="op">=</span><span class="va">tt1</span>, yy1<span class="op">=</span><span class="va">yy1</span>, tt2<span class="op">=</span><span class="va">tt2</span>, yy2<span class="op">=</span><span class="va">yy2</span><span class="op">)</span></span>
<span><span class="co">#&gt; $amp_1</span></span>
<span><span class="co">#&gt; [1] 0.8639946</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $amp_2</span></span>
<span><span class="co">#&gt; [1] 1.728164</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $amp_c</span></span>
<span><span class="co">#&gt; [1] 1.027955</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $stat</span></span>
<span><span class="co">#&gt; [1] 4.195124</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $pvalue</span></span>
<span><span class="co">#&gt; [1] 0.05259289</span></span>
<span></span>
<span></span>
<span><span class="co">## we can also test if if the rotational root distribution corresponds to the true tube upside</span></span>
<span><span class="co"># rotation segments</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">root.seg</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">root.seg</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,length <span class="op">=</span> <span class="va">splits</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>             color <span class="op">=</span> <span class="st">"red"</span>,size<span class="op">=</span><span class="fl">0.05</span>,linetype <span class="op">=</span> <span class="st">"solid"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_text</span><span class="op">(</span>label <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">20</span>,<span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="fl">250</span>,</span>
<span>                                 y<span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">root.seg</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>                                                length <span class="op">=</span> <span class="va">splits</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">*</span></span>
<span>                                    <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">root.seg</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">-</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">root.seg</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">/</span><span class="va">splits</span><span class="op">)</span>,</span>
<span>                                             length <span class="op">=</span><span class="va">splits</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>                                   <span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">root.seg</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>                                             length <span class="op">=</span> <span class="va">splits</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            color<span class="op">=</span><span class="st">"black"</span>,size<span class="op">=</span><span class="fl">1.5</span><span class="op">)</span> </span></code></pre></div>
<p><img src="MinirhizotronR_files/figure-html/Asess%20Rotational%20Bias-2.png" width="700"></p>
<pre><code><span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#ggsave("C:/Users/jocu0013/Documents/GitHub/MinirhizotronR/figures/rotation_splicing.png")</span></span>
<span></span>
<span><span class="co"># based on rotation center determined previously</span></span>
<span><span class="va">df1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span><span class="op">*</span><span class="va">pi</span>,<span class="op">-</span><span class="fl">2</span><span class="op">*</span><span class="va">pi</span>,<span class="op">-</span><span class="fl">2</span><span class="op">*</span><span class="va">pi</span><span class="op">/</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">rot.df</span><span class="op">$</span><span class="va">rotation</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">calibrated.phase</span> <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">cos</a></span><span class="op">(</span><span class="va">df1</span><span class="op">+</span><span class="op">(</span><span class="va">pi</span><span class="op">*</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">center.offset</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="fl">6.35</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co"># test the rotational root distribution vs the calibrated</span></span>
<span><span class="va">difftest</span> <span class="op">=</span> <span class="fu"><a href="../reference/LRTest_diff_phase.html">LRTest_diff_phase</a></span><span class="op">(</span>tt1 <span class="op">=</span> <span class="va">rot.df</span><span class="op">$</span><span class="va">rotation</span>, tt2 <span class="op">=</span>  <span class="va">rot.df</span><span class="op">$</span><span class="va">rotation</span>, yy1 <span class="op">=</span> <span class="va">calibrated.phase</span>, yy2 <span class="op">=</span> <span class="va">rot.df</span><span class="op">$</span><span class="va">sc.rotationpx</span>,</span>
<span>                  period <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/math-generics.html" class="external-link">round</a></span><span class="op">(</span><span class="va">pi</span><span class="op">*</span><span class="fl">6.35</span><span class="op">)</span><span class="op">)</span>;<span class="va">difftest</span></span>
<span><span class="co">#&gt; $phase_1</span></span>
<span><span class="co">#&gt; [1] 8.843225</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $phase_2</span></span>
<span><span class="co">#&gt; [1] 5.711852</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $phase_c</span></span>
<span><span class="co">#&gt; [1] 5.782338</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $l0</span></span>
<span><span class="co">#&gt; [1] -71.01061</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $la</span></span>
<span><span class="co">#&gt; [1] -70.9955</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $stat</span></span>
<span><span class="co">#&gt; [1] 0.03021531</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $pvalue</span></span>
<span><span class="co">#&gt; [1] 0.867672</span></span>
<span><span class="co"># tape estimation did not reflect the center of root distribution</span></span>
<span></span>
<span><span class="co">## alternative polar plot</span></span>
<span><span class="va">rot.df</span><span class="op">&lt;-</span><span class="va">rot.df</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>        <span class="co"># Use (rotation-0.5), not just id, to center label on each item</span></span>
<span>        angle<span class="op">=</span><span class="fl">90</span><span class="op">-</span><span class="fl">360</span><span class="op">*</span><span class="op">(</span><span class="va">rotation</span><span class="op">-</span><span class="fl">0.5</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">rotation</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>exag.rootpx <span class="op">=</span> <span class="va">rotation.rootpx</span><span class="op">**</span><span class="fl">1.75</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span>data<span class="op">=</span> <span class="va">rot.df</span>, </span>
<span>       <span class="fu">aes</span><span class="op">(</span><span class="va">rotation</span>,<span class="va">exag.rootpx</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_bar</span><span class="op">(</span>fill<span class="op">=</span><span class="st">"indianred"</span>,</span>
<span>           stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_text</span><span class="op">(</span>data<span class="op">=</span><span class="va">rot.df</span>,</span>
<span>            <span class="fu">aes</span><span class="op">(</span>y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">exag.rootpx</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">exag.rootpx</span><span class="op">)</span><span class="op">*</span><span class="fl">0.925</span>,label<span class="op">=</span><span class="va">rotation</span><span class="op">)</span>,hjust <span class="op">=</span> <span class="fl">0.5</span>, size <span class="op">=</span> <span class="fl">3</span>,color <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">""</span><span class="op">)</span><span class="op">+</span><span class="fu">xlab</span><span class="op">(</span><span class="st">""</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">rot.df</span><span class="op">$</span><span class="va">exag.rootpx</span><span class="op">)</span><span class="op">*</span><span class="fl">0.1</span><span class="op">)</span>,</span>
<span>                                       labels <span class="op">=</span> <span class="st">""</span>,</span>
<span>                                       limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>     <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">rot.df</span><span class="op">$</span><span class="va">exag.rootpx</span><span class="op">)</span><span class="op">/</span><span class="fl">1.25</span>,</span>
<span>     <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">rot.df</span><span class="op">$</span><span class="va">exag.rootpx</span><span class="op">)</span><span class="op">*</span><span class="fl">1</span></span>
<span>   <span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span> <span class="fu">scale_x_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="st">""</span>,breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">rot.df</span><span class="op">$</span><span class="va">exag.rootpx</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu">coord_polar</span><span class="op">(</span>start<span class="op">=</span><span class="op">(</span><span class="va">splits</span> <span class="op">-</span> <span class="va">ryth.test</span><span class="op">$</span><span class="va">phase</span> <span class="op">)</span><span class="op">*</span><span class="fl">1.15</span><span class="op">)</span></span></code></pre>
<p><img src="MinirhizotronR_files/figure-html/Asess%20Rotational%20Bias-3.png" width="700">
## Turnover Estimates Now its time for Turnover</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># the package offers two methods two estimate turnover. </span></span>
<span><span class="co">#The function Turnover.TC() makes a comparison between two timepoints and determines production in relation to total biomass. </span></span>
<span></span>
<span><span class="va">turn1</span> <span class="op">=</span> <span class="fu"><a href="../reference/Turnover.TC.html">Turnover.TC</a></span><span class="op">(</span><span class="va">skl_Oulanka2023_Session01_T067</span>,<span class="va">skl_Oulanka2023_Session03_T067</span>,method <span class="op">=</span> <span class="st">"kimura"</span><span class="op">)</span>;<span class="va">turn1</span></span>
<span><span class="co">#&gt;          sum    sum.1   sum.2   sum.3   sum.4</span></span>
<span><span class="co">#&gt; sum 1536.412 1492.178 -44.234 -0.0288 -0.0296</span></span>
<span><span class="co"># PDC stands for production, decay, and constant - extracting the variables from a 'RootDetector' format turnover output</span></span>
<span><span class="va">turn2</span> <span class="op">=</span> <span class="fu"><a href="../reference/Turnover.DPC.html">Turnover.DPC</a></span><span class="op">(</span><span class="va">TurnoverDPC_data</span>, product.layer <span class="op">=</span> <span class="fl">2</span>, decay.layer <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>;<span class="va">turn2</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 7</span></span></span>
<span><span class="co">#&gt;     tape constant production   decay newgrowth.ratio decay.ratio constant.ratio</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> <span style="text-decoration: underline;">887</span>012   <span style="text-decoration: underline;">438</span>681    2<span style="text-decoration: underline;">770</span>138 3<span style="text-decoration: underline;">355</span>722           0.863       0.884         0.066<span style="text-decoration: underline;">8</span></span></span>
<span><span class="co"># we can also return production, decay, and constant layers instead and go apply depth stats</span></span>
<span><span class="va">Turnmap</span> <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/coerce.html" class="external-link">as.array</a></span><span class="op">(</span><span class="va">TurnoverDPC_data</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">2000</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="va">turn3</span> <span class="op">=</span> <span class="fu"><a href="../reference/Turnover.DPC.html">Turnover.DPC</a></span><span class="op">(</span><span class="va">Turnmap</span>, im.return <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span></span>
<span><span class="va">turn3</span><span class="op">$</span><span class="va">production</span> <span class="op">=</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/brick.html" class="external-link">brick</a></span><span class="op">(</span><span class="va">turn3</span><span class="op">$</span><span class="va">production</span><span class="op">)</span></span>
<span><span class="va">turn3</span><span class="op">$</span><span class="va">constant</span> <span class="op">=</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/brick.html" class="external-link">brick</a></span><span class="op">(</span><span class="va">turn3</span><span class="op">$</span><span class="va">constant</span><span class="op">)</span></span>
<span><span class="va">turn3</span><span class="op">$</span><span class="va">decay</span> <span class="op">=</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/brick.html" class="external-link">brick</a></span><span class="op">(</span><span class="va">turn3</span><span class="op">$</span><span class="va">decay</span><span class="op">)</span></span>
<span><span class="co"># adapt depth map</span></span>
<span></span>
<span><span class="va">mask</span> <span class="op">=</span> <span class="va">Turnmap</span> <span class="op">!=</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">Turnmap</span><span class="op">)</span></span>
<span><span class="va">bm.turn</span> <span class="op">=</span> <span class="fu"><a href="../reference/create.depthmap.html">create.depthmap</a></span><span class="op">(</span><span class="va">Turnmap</span>,mask <span class="op">=</span> <span class="va">mask</span>,dpi <span class="op">=</span> <span class="fl">150</span><span class="op">)</span></span>
<span><span class="va">bm.turn2</span> <span class="op">=</span><span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/brick.html" class="external-link">brick</a></span><span class="op">(</span><span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">bm.turn</span><span class="op">)</span><span class="op">)</span></span>
<span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/extent.html" class="external-link">extent</a></span><span class="op">(</span><span class="va">turn3</span><span class="op">$</span><span class="va">production</span><span class="op">)</span> <span class="op">=</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/extent.html" class="external-link">extent</a></span><span class="op">(</span><span class="va">bm.turn2</span><span class="op">)</span></span>
<span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/extent.html" class="external-link">extent</a></span><span class="op">(</span><span class="va">turn3</span><span class="op">$</span><span class="va">decay</span><span class="op">)</span> <span class="op">=</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/extent.html" class="external-link">extent</a></span><span class="op">(</span><span class="va">bm.turn2</span><span class="op">)</span></span>
<span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/extent.html" class="external-link">extent</a></span><span class="op">(</span><span class="va">turn3</span><span class="op">$</span><span class="va">constant</span><span class="op">)</span> <span class="op">=</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/extent.html" class="external-link">extent</a></span><span class="op">(</span><span class="va">bm.turn2</span><span class="op">)</span></span>
<span> <span class="va">prd</span> <span class="op">=</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/zonal.html" class="external-link">zonal</a></span><span class="op">(</span><span class="va">turn3</span><span class="op">$</span><span class="va">production</span>,<span class="va">bm.turn2</span>,<span class="st">"sum"</span><span class="op">)</span></span>
<span> <span class="va">dec</span> <span class="op">=</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/zonal.html" class="external-link">zonal</a></span><span class="op">(</span><span class="va">turn3</span><span class="op">$</span><span class="va">decay</span>,<span class="va">bm.turn2</span>,<span class="st">"sum"</span><span class="op">)</span></span>
<span> <span class="va">con</span> <span class="op">=</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/zonal.html" class="external-link">zonal</a></span><span class="op">(</span><span class="va">turn3</span><span class="op">$</span><span class="va">constant</span>,<span class="va">bm.turn2</span>,<span class="st">"sum"</span><span class="op">)</span></span>
<span> </span>
<span> <span class="va">df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>prd <span class="op">=</span> <span class="va">prd</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>,dec <span class="op">=</span>  <span class="va">dec</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>,con <span class="op">=</span>  <span class="va">con</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, x <span class="op">=</span> <span class="va">prd</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, rootpx <span class="op">=</span> <span class="va">root.sum</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">prd</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span> <span class="fu">ggplot</span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>   <span class="co"># scale_y_continuous(limits = c(0,1))+</span></span>
<span>   <span class="co"># scale_x_continuous(limits = c(0,40))+</span></span>
<span>   <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>   <span class="fu">geom_point</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">prd</span>,color <span class="op">=</span> <span class="st">"prd"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">prd</span><span class="op">/</span><span class="va">rootpx</span>,color <span class="op">=</span> <span class="st">"prd"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>   <span class="fu">geom_point</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">dec</span>,color <span class="op">=</span> <span class="st">"dec"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">dec</span><span class="op">/</span><span class="va">rootpx</span>,color <span class="op">=</span> <span class="st">"dec"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>   <span class="fu">geom_point</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">con</span>,color <span class="op">=</span> <span class="st">"con"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">con</span><span class="op">/</span><span class="va">rootpx</span>,color <span class="op">=</span> <span class="st">"con"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>   <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">prd</span>,color <span class="op">=</span> <span class="st">"prd"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">prd</span><span class="op">/</span><span class="va">rootpx</span>,color <span class="op">=</span> <span class="st">"prd"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>   <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">dec</span>,color <span class="op">=</span> <span class="st">"dec"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">dec</span><span class="op">/</span><span class="va">rootpx</span>,color <span class="op">=</span> <span class="st">"dec"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>   <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">con</span>,color <span class="op">=</span> <span class="st">"con"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">con</span><span class="op">/</span><span class="va">rootpx</span>,color <span class="op">=</span> <span class="st">"con"</span><span class="op">)</span><span class="op">)</span><span class="co"># + </span></span></code></pre></div>
<p><img src="MinirhizotronR_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>   <span class="co">#geom_point(aes(y = rootpx,color = "rootpx")) + geom_line(aes(y = rootpx,color = "rootpx"))</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Johannes Cunow.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
